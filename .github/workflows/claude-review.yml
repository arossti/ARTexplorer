name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**.js'
      - '**.css'
      - '**.html'

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          # Get the raw diff for context
          git diff origin/${{ github.base_ref }}...HEAD > diff.txt
          echo "diff_size=$(wc -c < diff.txt)" >> $GITHUB_OUTPUT

          # Truncate to 40KB with explicit marker so Claude knows
          if [ $(wc -c < diff.txt) -gt 40000 ]; then
            head -c 40000 diff.txt > diff_truncated.txt
            echo "" >> diff_truncated.txt
            echo "=== DIFF TRUNCATED AT 40KB ‚Äî remaining changes not shown ===" >> diff_truncated.txt
          else
            cp diff.txt diff_truncated.txt
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Claude Review
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read and escape diff content for JSON
          DIFF_CONTENT=$(cat diff_truncated.txt | jq -Rs .)

          # Build the prompt
          PROMPT="Review this PR diff for code quality issues.\n\nIMPORTANT RULES:\n- The input is a git diff. Lines with '+' are additions, '-' are removals.\n- Do NOT flag removed code (lines starting with '-') as issues.\n- The diff may be TRUNCATED. If the input ends abruptly or mid-function, that is a truncation artifact ‚Äî do NOT report it as incomplete or missing code.\n- Only report issues you can clearly see in the ADDED lines (lines starting with '+').\n\nFocus ONLY on:\n1. **Debug code**: Temporary debugging like 'console.log(variable)'. IGNORE intentional logging with emoji prefixes or structured messages ‚Äî these are user feedback.\n2. **Commented-out code**: Dead code blocks that should be deleted\n3. **Code duplication**: Repeated added code blocks (>5 lines) that could be consolidated\n4. **Unused variables**: Declared but never used in the visible diff\n\nDO NOT comment on:\n- Style preferences or alternative implementations\n- Architecture suggestions or performance micro-optimizations\n- console.warn/console.error (intentional error handling)\n- console.log with emoji prefixes or structured messages (intentional user feedback)\n- Large functions (not reliably detectable from diffs alone)\n- Truncated or incomplete-looking code at the end of the input\n- Markdown (.md) documentation files\n\nFormat your response as a markdown checklist. If no issues found, say 'No issues found.'\n\nDiff:\n\`\`\`\n"

          # Create JSON payload using jq for proper escaping
          PAYLOAD=$(jq -n \
            --arg prompt "$PROMPT" \
            --argjson diff "$DIFF_CONTENT" \
            '{
              model: "claude-sonnet-4-20250514",
              max_tokens: 2048,
              messages: [{
                role: "user",
                content: ($prompt + $diff + "\n```")
              }]
            }')

          # Make API request
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "$PAYLOAD")

          # Check for error in response
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown API error"')
            echo "API Error: $ERROR_MSG"
            echo "API Error: $ERROR_MSG" > review.md
          else
            # Extract the text content from Claude's response
            REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // "Error: Could not parse response"')
            echo "$REVIEW" > review.md
          fi

      - name: Post PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review.md', 'utf8');
            const diffSize = '${{ steps.diff.outputs.diff_size }}';

            const body = `## ü§ñ Claude Code Review

            ${review}

            ---
            <details>
            <summary>‚ÑπÔ∏è About this review</summary>

            This automated review checks for:
            - Debug statements (console.log)
            - Commented-out code
            - Code duplication
            - Unused variables

            **Human review required** - these are suggestions only.
            Diff size: ${diffSize} bytes
            </details>`;

            // Find existing comment to update (avoid spam)
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('ü§ñ Claude Code Review')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
